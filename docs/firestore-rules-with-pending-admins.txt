rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Pending signups collection - allow unauthenticated writes (needed for signup before authentication)
    match /pending_signups/{token} {
      allow create: if true;  // Anyone can create pending signup
      allow read: if true;    // Anyone can read (for verification)
      allow update: if true;  // Allow updates (for marking as verified)
      allow delete: if true;  // Allow deletion (cleanup)
    }
    
    // Pending admins - email verification for new admins (admin portal)
    match /pending_admins/{token} {
      allow create: if true;   // Superadmin creates when adding admin
      allow read: if true;     // Verify page reads by token
      allow update: if true;   // Mark as verified after email click
      allow delete: if true;   // Optional cleanup
    }
    
    // Counters collection
    match /counters/{counterId} {
      allow read: if true;
      allow write: if true;
    }
    
    // Caregivers collection
    match /caregivers/{documentId} {
      allow read: if true;
      allow create: if request.auth != null && 
                       request.resource.data.authUid == request.auth.uid;
      allow update: if request.auth != null && 
                       resource.data.authUid == request.auth.uid;
      allow delete: if true;  // For archiving
      allow write: if true;   // CRITICAL: For restore function!
    }
    
    // Patients collection
    match /patients/{documentId} {
      allow read: if true;
      allow create: if request.auth != null && 
                       request.resource.data.authUid == request.auth.uid;
      allow update: if request.auth != null && 
                       resource.data.authUid == request.auth.uid;
      allow delete: if true;  // For archiving
      allow write: if true;   // CRITICAL: For restore function!
    }
    
    // Admins collection
    match /admins/{documentId} {
      allow read: if true;
      allow write: if true;   // Admin portal manages admins
      allow delete: if true;  // For archiving
    }
    
    // Archived collection - CRITICAL for restore!
    match /archived/{documentId} {
      allow read: if true;   // Read archived items
      allow write: if true;   // Create archived items
      allow delete: if true; // CRITICAL: Delete during restore!
    }
    
    // Logs collection - for system activity logs
    match /logs/{logId} {
      allow read: if true;   // Read logs (for superadmin log page)
      allow write: if true;  // Write logs (for automatic logging)
    }
    
    // Connections: caregiver–patient links (QR code flow)
    match /connections/{connectionId} {
      allow read: if request.auth != null
        && (resource.data.caregiverId == request.auth.uid
            || resource.data.patientId == request.auth.uid);
      allow create: if request.auth != null
        && request.resource.data.caregiverId == request.auth.uid;
      allow update, delete: if request.auth != null
        && (resource.data.caregiverId == request.auth.uid
            || resource.data.patientId == request.auth.uid);
    }
    
    // Notifications: assistance requests (patient → caregiver)
    match /notifications/{notificationId} {
      allow read: if request.auth != null
        && resource.data.caregiverId == request.auth.uid;
      allow create: if request.auth != null
        && request.resource.data.patientId == request.auth.uid;
      allow update, delete: if request.auth != null
        && resource.data.caregiverId == request.auth.uid;
    }
  }
}
